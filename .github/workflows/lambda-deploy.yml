name: Deploy TravelStyle to Lambda

on:
  push:
    branches: [main]
    paths: ['backend/**', '.github/workflows/**']
  workflow_dispatch:
  workflow_run:
    workflows: ["Backend Quality CI/CD"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      FUNCTION_NAME: ${{ secrets.LAMBDA_FUNCTION_NAME }}
      REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
      API_NAME: TravelStyleAPI

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Create Lambda layers and package
        run: |
          cd backend

          # Create directories for layers
          mkdir -p layers/python
          mkdir -p layers/app

          # Install dependencies to layer
          pip install -r requirements-lambda.txt --target layers/python --no-cache-dir --no-deps

          # Copy only app code to separate layer
          cp -r app layers/app/

          # Clean up dependencies layer
          cd layers/python
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "test" -exec rm -rf {} + 2>/dev/null || true
          find . -name "*.pyc" -delete 2>/dev/null || true
          find . -name "*.pyo" -delete 2>/dev/null || true
          find . -name "*.pyd" -delete 2>/dev/null || true
          find . -name "*.so" -delete 2>/dev/null || true
          find . -name "*.dll" -delete 2>/dev/null || true
          find . -name "*.dylib" -delete 2>/dev/null || true
          find . -name "*.txt" -not -name "*.py" -delete 2>/dev/null || true
          find . -name "*.md" -delete 2>/dev/null || true
          find . -name "*.rst" -delete 2>/dev/null || true
          find . -name "*.html" -delete 2>/dev/null || true
          find . -type d -name "examples" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "docs" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "doc" -exec rm -rf {} + 2>/dev/null || true
          cd ..

          # Create layer packages
          cd python
          zip -r ../dependencies-layer.zip . -x "*.pyc" "*.pyo" "__pycache__/*" "tests/*" "test/*"
          cd ..

          cd app
          zip -r ../app-layer.zip . -x "*.pyc" "*.pyo" "__pycache__/*" "tests/*" "test/*"
          cd ..

          # Create minimal function package (just the handler)
          mkdir -p function
          echo 'import sys; sys.path.insert(0, "/opt/python"); sys.path.insert(0, "/opt/app")' > function/lambda_function.py
          echo 'from app.main import handler' >> function/lambda_function.py
          cd function
          zip -r ../lambda-deploy.zip .
          cd ..

          # Move zip files to backend directory for deployment step
          mv dependencies-layer.zip ../
          mv app-layer.zip ../
          mv lambda-deploy.zip ../

          echo "Layer sizes:"
          echo "Dependencies layer: $(du -h ../dependencies-layer.zip | cut -f1)"
          echo "App layer: $(du -h ../app-layer.zip | cut -f1)"
          echo "Function package: $(du -h ../lambda-deploy.zip | cut -f1)"

          # Debug: List files in backend directory
          echo "Files in backend directory:"
          ls -la ../

          # Debug: Check if zip files exist
          echo "Checking zip files:"
          ls -la ../*.zip || echo "No zip files found"

      - name: Deploy to Lambda
        run: |
          cd backend

          # Debug: Check what files are available
          echo "Files in backend directory:"
          ls -la

          # Debug: Check if zip files exist
          echo "Checking for zip files:"
          ls -la *.zip || echo "No zip files found in backend directory"

          # Create environment variables
          cat > env.json << EOF
          {
            "Variables": {
              "OPENAI_API_KEY": "${{ secrets.OPENAI_API_KEY }}",
              "OPENAI_ORG_ID": "${{ secrets.OPENAI_ORG_ID }}",
              "QLOO_API_KEY": "${{ secrets.QLOO_API_KEY }}",
              "OPENWEATHER_API_KEY": "${{ secrets.OPENWEATHER_API_KEY }}",
              "EXCHANGE_API_KEY": "${{ secrets.EXCHANGE_API_KEY }}",
              "SUPABASE_URL": "${{ secrets.SUPABASE_URL }}",
              "SUPABASE_KEY": "${{ secrets.SUPABASE_KEY }}",
              "API_V1_STR": "/api/v1",
              "PROJECT_NAME": "TravelStyle AI",
              "VERSION": "1.0.0"
            }
          }
          EOF

          # Create or update layers
          echo "Creating/updating Lambda layers..."

          # Create dependencies layer
          DEPENDENCIES_LAYER_ARN=$(aws lambda publish-layer-version \
            --layer-name "TravelStyle-Dependencies" \
            --description "Dependencies for TravelStyle API" \
            --zip-file fileb://dependencies-layer.zip \
            --compatible-runtimes python3.13 \
            --query 'LayerVersionArn' --output text 2>/dev/null || echo "")

          # Create app layer
          APP_LAYER_ARN=$(aws lambda publish-layer-version \
            --layer-name "TravelStyle-App" \
            --description "Application code for TravelStyle API" \
            --zip-file fileb://app-layer.zip \
            --compatible-runtimes python3.13 \
            --query 'LayerVersionArn' --output text 2>/dev/null || echo "")

          # Deploy or update function with layers
          if aws lambda get-function --function-name $FUNCTION_NAME &>/dev/null; then
            echo "Updating existing function..."
            aws lambda update-function-code --function-name $FUNCTION_NAME --zip-file fileb://lambda-deploy.zip
            aws lambda update-function-configuration \
              --function-name $FUNCTION_NAME \
              --environment file://env.json \
              --timeout 30 \
              --memory-size 512 \
              --layers $DEPENDENCIES_LAYER_ARN $APP_LAYER_ARN
          else
            echo "Creating new function..."
            aws lambda create-function \
              --function-name $FUNCTION_NAME \
              --runtime python3.13 \
              --handler lambda_function.handler \
              --role arn:aws:iam::$(aws sts get-caller-identity --query Account --output text):role/TravelStyle-Lambda-Role \
              --zip-file fileb://lambda-deploy.zip \
              --environment file://env.json \
              --timeout 30 \
              --memory-size 512 \
              --layers $DEPENDENCIES_LAYER_ARN $APP_LAYER_ARN
          fi

      - name: Setup API Gateway
        run: |
          # Get or create API Gateway
          API_ID=$(aws apigatewayv2 get-apis --query "Items[?Name=='$API_NAME'].ApiId" --output text 2>/dev/null || echo "")

          if [ -z "$API_ID" ] || [ "$API_ID" = "None" ]; then
            API_ID=$(aws apigatewayv2 create-api --name "$API_NAME" --protocol-type HTTP --query "ApiId" --output text)
          fi

          # Create integration
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          LAMBDA_ARN="arn:aws:lambda:$REGION:$ACCOUNT_ID:function:$FUNCTION_NAME"

          INTEGRATION_ID=$(aws apigatewayv2 create-integration \
            --api-id $API_ID \
            --integration-type AWS_PROXY \
            --integration-uri $LAMBDA_ARN \
            --payload-format-version 2.0 \
            --query 'IntegrationId' --output text 2>/dev/null || echo "")

          # Create routes
          aws apigatewayv2 create-route --api-id $API_ID --route-key "ANY /" --target "integrations/$INTEGRATION_ID" 2>/dev/null || echo "Route exists"
          aws apigatewayv2 create-route --api-id $API_ID --route-key "ANY /{proxy+}" --target "integrations/$INTEGRATION_ID" 2>/dev/null || echo "Route exists"

          # Create stage
          aws apigatewayv2 create-stage --api-id $API_ID --stage-name '$default' --auto-deploy 2>/dev/null || echo "Stage exists"

          # Set permissions
          aws lambda add-permission \
            --function-name $FUNCTION_NAME \
            --statement-id "api-gateway-invoke" \
            --action lambda:InvokeFunction \
            --principal apigateway.amazonaws.com \
            --source-arn "arn:aws:execute-api:$REGION:$ACCOUNT_ID:$API_ID/*/*/*" 2>/dev/null || echo "Permission exists"

          # Output endpoint
          ENDPOINT="https://$API_ID.execute-api.$REGION.amazonaws.com"
          echo "API_ENDPOINT=$ENDPOINT" >> $GITHUB_ENV
          echo "âœ… Deployed to: $ENDPOINT"

      - name: Test deployment
        run: |
          sleep 10
          curl -s $API_ENDPOINT/health || echo "Health check failed"
          echo "ğŸ‰ TravelStyle API deployed successfully!"
          echo "ğŸŒ Endpoint: $API_ENDPOINT"
